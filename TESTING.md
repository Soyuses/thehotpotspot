# Руководство по тестированию проекта TheHotPotSpot

## Обзор

Этот документ описывает систему тестирования проекта TheHotPotSpot, включая unit тесты, интеграционные тесты, тесты безопасности и CI/CD pipeline.

## Структура тестов

### Unit тесты
- **Расположение**: `src/tests/`
- **Покрытие**: Все основные модули проекта
- **Запуск**: `cargo test --lib`

#### Модули с unit тестами:
- `core.rs` - Основные структуры данных и логика
- `api.rs` - API запросы и ответы
- `blockchain.rs` - Блокчейн логика
- `security.rs` - Тесты безопасности
- `config.rs` - Конфигурация системы
- `consensus.rs` - Алгоритм консенсуса
- `database.rs` - Работа с базой данных
- `hd_wallet.rs` - HD кошельки
- `kyc_aml.rs` - KYC/AML система

### Интеграционные тесты
- **Расположение**: `src/tests/integration.rs`
- **Покрытие**: Взаимодействие между модулями
- **Запуск**: `cargo test --test integration`

#### Тестируемые интеграции:
- Блокчейн + База данных
- KYC/AML + Кошельки
- Консенсус + Сеть
- API + Модули
- Видеонаблюдение + Система
- Франшизная сеть
- Регуляторные экспорты
- Relayer сервис
- Observability
- API versioning

### Тесты безопасности
- **Расположение**: `src/tests/security.rs`
- **Покрытие**: Защита от различных атак
- **Запуск**: `cargo test --test security`

#### Тестируемые угрозы:
- 51% атаки
- Концентрация токенов
- Быстрое накопление токенов
- Координированные атаки
- Манипуляция utility токенами
- Повторное использование чеков
- Подделка номеров телефонов
- Атаки разделения сети
- Экономические атаки
- Социальная инженерия
- Временные атаки
- Кросс-чейн атаки

### Нагрузочные тесты
- **Расположение**: `src/tests/load_testing.rs`
- **Покрытие**: Производительность системы
- **Запуск**: `cargo test --test load_testing`

#### Тестируемые сценарии:
- Высокий объем покупок
- Параллельные переносы баланса
- Использование памяти под нагрузкой
- Стресс-тестирование проверок безопасности
- Пределы масштабируемости
- Симуляция роста сети
- Экстремальные сценарии

### Тесты атак
- **Расположение**: `src/tests/attack_scenarios.rs`
- **Покрытие**: Различные сценарии атак
- **Запуск**: `cargo test --test attack_scenarios`

#### Тестируемые атаки:
- Быстрое накопление токенов
- Координированные атаки
- Манипуляция utility токенами
- Повторное использование чеков
- Подделка номеров телефонов
- Атаки разделения сети
- Экономические атаки
- Социальная инженерия
- Временные атаки
- Кросс-чейн атаки

## Запуск тестов

### Все тесты
```bash
# PowerShell
.\run-tests.ps1

# Bash
./run-tests.sh
```

### Отдельные категории тестов
```bash
# Unit тесты
cargo test --lib

# Интеграционные тесты
cargo test --test integration

# Тесты безопасности
cargo test --test security

# Нагрузочные тесты
cargo test --test load_testing

# Тесты атак
cargo test --test attack_scenarios
```

### Конкретные тесты
```bash
# Тест конкретной функции
cargo test test_function_name

# Тест конкретного модуля
cargo test --test module_name

# Тест с выводом
cargo test -- --nocapture

# Тест в одном потоке
cargo test -- --test-threads=1
```

## CI/CD Pipeline

### GitHub Actions
- **Файл**: `.github/workflows/ci.yml`
- **Триггеры**: Push, Pull Request
- **Платформы**: Ubuntu, Windows, macOS

#### Этапы CI/CD:
1. **Lint и Format** - Проверка кода
2. **Unit Tests** - Unit тесты
3. **Integration Tests** - Интеграционные тесты
4. **Load Tests** - Нагрузочные тесты
5. **Security Tests** - Тесты безопасности
6. **Build** - Сборка проекта
7. **Security Scan** - Сканирование безопасности
8. **Test Matrix** - Тестирование на разных платформах
9. **Docs** - Генерация документации
10. **Deploy** - Деплой (только main ветка)

### Сканирование безопасности
- **Файл**: `.github/workflows/security.yml`
- **Триггеры**: Расписание, Push, Pull Request

#### Типы сканирования:
- **Dependency Scan** - Сканирование зависимостей
- **Code Scan** - Сканирование кода
- **Secret Scan** - Поиск секретов
- **Config Scan** - Сканирование конфигурации
- **Docker Scan** - Сканирование Docker образов
- **CodeQL** - Анализ кода
- **License Scan** - Проверка лицензий
- **Performance Security** - Анализ производительности и безопасности

## Конфигурация

### Cargo.toml
```toml
[dev-dependencies]
tokio-test = "0.4"
criterion = "0.5"
proptest = "1.0"
mockall = "0.12"
tempfile = "3.0"
assert_cmd = "2.0"
predicates = "3.0"
serial_test = "3.0"
testcontainers = "0.15"
```

### deny.toml
Конфигурация для cargo-deny:
- Проверка уязвимостей
- Проверка лицензий
- Проверка дублирующихся пакетов
- Проверка источников

### clippy.toml
Конфигурация для clippy:
- Дополнительные проверки безопасности
- Проверки производительности
- Проверки стиля кода

### test-config.toml
Конфигурация для тестирования:
- Настройки тестов
- Настройки отчетов
- Настройки уведомлений

## Отчеты

### Покрытие кода
```bash
# Установка инструмента
cargo install cargo-tarpaulin

# Запуск с покрытием
cargo tarpaulin --out Html
```

### Производительность
```bash
# Установка инструмента
cargo install cargo-criterion

# Запуск бенчмарков
cargo bench
```

### Безопасность
```bash
# Установка инструментов
cargo install cargo-audit
cargo install cargo-deny

# Запуск проверок
cargo audit
cargo deny check
```

## Лучшие практики

### Написание тестов
1. **Именование**: Используйте описательные имена тестов
2. **Структура**: Arrange-Act-Assert (AAA)
3. **Изоляция**: Каждый тест должен быть независимым
4. **Покрытие**: Стремитесь к высокому покрытию кода
5. **Документация**: Документируйте сложные тесты

### Тестирование безопасности
1. **Угрозы**: Тестируйте все известные угрозы
2. **Граничные случаи**: Проверяйте граничные условия
3. **Атаки**: Симулируйте реальные атаки
4. **Валидация**: Проверяйте входные данные
5. **Аудит**: Регулярно проводите аудит безопасности

### CI/CD
1. **Автоматизация**: Автоматизируйте все проверки
2. **Быстрота**: Оптимизируйте время выполнения
3. **Надежность**: Обеспечьте стабильность pipeline
4. **Уведомления**: Настройте уведомления об ошибках
5. **Мониторинг**: Отслеживайте метрики pipeline

## Устранение неполадок

### Частые проблемы
1. **Тесты не запускаются**: Проверьте зависимости
2. **Медленные тесты**: Оптимизируйте тесты
3. **Ложные срабатывания**: Улучшите изоляцию тестов
4. **Проблемы с памятью**: Проверьте утечки памяти
5. **Проблемы с сетью**: Используйте моки

### Отладка
```bash
# Подробный вывод
cargo test -- --nocapture

# Отладка конкретного теста
cargo test test_name -- --nocapture

# Проверка зависимостей
cargo tree

# Анализ сборки
cargo build --verbose
```

## Метрики

### Цели покрытия
- **Unit тесты**: > 90%
- **Интеграционные тесты**: > 80%
- **Тесты безопасности**: > 95%
- **Нагрузочные тесты**: > 70%

### Производительность
- **Время выполнения тестов**: < 10 минут
- **Время сборки**: < 5 минут
- **Время деплоя**: < 15 минут

### Безопасность
- **Уязвимости**: 0 критических
- **Лицензии**: Только разрешенные
- **Секреты**: 0 в коде
- **Зависимости**: Все актуальные

## Заключение

Система тестирования TheHotPotSpot обеспечивает:
- Высокое качество кода
- Безопасность системы
- Производительность
- Надежность
- Соответствие стандартам

Регулярное выполнение тестов и мониторинг метрик помогает поддерживать высокое качество проекта.
